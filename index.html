<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - ‡πÄ‡∏Ç‡∏ï‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .upload-area {
            border: 3px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .upload-area.dragover {
            border-color: #3182ce;
            background-color: #bee3f8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-6">
            <h1 class="text-3xl font-bold text-center">üè• Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>
            <p class="text-center text-blue-100 mt-2 text-lg">‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏ï‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4 ‡πÇ‡∏î‡∏¢ ‡∏ó‡∏µ‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå (Situation Awareness Team: SAT)</p>
            <div class="text-center mt-4 text-blue-100">
                <p id="dataDateRange" class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="startDate">-</span> ‡∏ñ‡∏∂‡∏á <span id="endDate">-</span></p>
                <p class="text-xs mt-1">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° M-EBS ‡∏Å‡∏£‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏Ñ</p>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">

        <!-- ===== Filter Bar (Cascading & Disease filters) ===== -->
        <div id="filterBar" class="bg-white rounded-xl card-shadow p-6 mb-8 border-l-4 border-indigo-600">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div>
                    <label for="filterProvince" class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                    <select id="filterProvince" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
                <div>
                    <label for="filterDistrict" class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                    <select id="filterDistrict" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                        <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>
                    </select>
                </div>
                <div>
                    <label for="filterSubdistrict" class="block text-sm font-medium text-gray-700 mb-1">‡∏ï‡∏≥‡∏ö‡∏•</label>
                    <select id="filterSubdistrict" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                        <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>
                    </select>
                </div>
                <div>
                    <label for="filterGroup" class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</label>
                    <select id="filterGroup" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
                <div>
                    <label for="filterEvent" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</label>
                    <select id="filterEvent" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-2">
                <button id="resetFilters" type="button" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
                <span class="text-xs text-gray-500">* ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Üí ‡∏ï‡∏≥‡∏ö‡∏• ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö, ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
            </div>
        </div>


        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-700 rounded-xl p-6 text-white card-shadow transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p id="totalEvents" class="text-3xl font-bold">1,247</p>
                    </div>
                    <div class="text-5xl opacity-80">üìä</div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-emerald-500 via-green-600 to-teal-700 rounded-xl p-6 text-white card-shadow transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°</p>
                        <p id="totalCases" class="text-3xl font-bold">8,934</p>
                    </div>
                    <div class="text-5xl opacity-80">üë•</div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-red-500 via-rose-600 to-pink-700 rounded-xl p-6 text-white card-shadow transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</p>
                        <p id="totalDeaths" class="text-3xl font-bold">89</p>
                    </div>
                    <div class="text-5xl opacity-80">‚ö†Ô∏è</div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 via-violet-600 to-indigo-700 rounded-xl p-6 text-white card-shadow transform hover:scale-105 transition-transform">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</p>
                        <p id="totalProvinces" class="text-3xl font-bold">18</p>
                    </div>
                    <div class="text-5xl opacity-80">üìç</div>
                </div>
            </div>
        </div>

        <div id="chartsSection">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-indigo-500">
                    <div class="flex items-center mb-6">
                        <div class="bg-indigo-100 p-3 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 id="eventGroupTitle" class="text-xl font-semibold text-gray-800">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
                            <p class="text-gray-600 text-sm">‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ</p>
                        </div>
                    </div>
                    <div class="h-96">
                        <canvas id="eventGroupPieChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-blue-500">
                    <div class="flex items-center mb-6">
                        <div class="bg-blue-100 p-3 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 id="eventListTitle" class="text-xl font-semibold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
                            <p class="text-gray-600 text-sm">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö</p>
                        </div>
                    </div>
                    <div class="h-96 overflow-y-auto">
                        <div id="eventListTable"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl card-shadow p-8 mb-8 border-l-4 border-green-500">
                <div class="flex items-center mb-6">
                    <div class="bg-green-100 p-3 rounded-lg mr-4">
                        <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 id="provinceTitle" class="text-xl font-semibold text-gray-800">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h3>
                        <p class="text-gray-600 text-sm">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</p>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="provinceChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl card-shadow p-8 mb-8 border-l-4 border-purple-500">
                <div class="flex items-center mb-6">
                    <div class="bg-purple-100 p-3 rounded-lg mr-4">
                        <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 id="timelineTitle" class="text-xl font-semibold text-gray-800">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</h3>
                        <p class="text-gray-600 text-sm">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-orange-500">
                    <div class="flex items-center mb-6">
                        <div class="bg-orange-100 p-3 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 id="priorityTitle" class="text-xl font-semibold text-gray-800">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß</h3>
                            <p class="text-gray-600 text-sm">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-teal-500">
                    <div class="flex items-center mb-6">
                        <div class="bg-teal-100 p-3 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 id="statusTitle" class="text-xl font-semibold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
                            <p class="text-gray-600 text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="dataTableSection" class="bg-white rounded-xl card-shadow p-8 mt-8 border-l-4 border-gray-500">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="bg-gray-100 p-3 rounded-lg mr-4">
                        <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                        <p class="text-gray-600 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</p>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full table-auto">
                    <thead class="bg-gray-50">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="mt-8">
            <div class="bg-white rounded-xl card-shadow border-l-4 border-indigo-500 overflow-hidden">
                <button id="uploadToggle" class="w-full p-6 text-left hover:bg-gray-50 transition-colors flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-indigo-100 p-3 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                            <p class="text-gray-600 text-sm">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                        </div>
                    </div>
                    <svg id="uploadArrow" class="w-6 h-6 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <div id="uploadContent" class="hidden border-t border-gray-200 p-8">
                    <div id="authForm" class="mb-6">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-yellow-800 font-medium">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Password">
                            </div>
                        </div>
                        <button id="authBtn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                        </button>
                        <div id="authError" class="hidden mt-2 text-red-600 text-sm"></div>
                    </div>

                    <div id="dateRangeForm" class="mb-6 hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center mb-3">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-blue-800 font-medium">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                    <input type="date" id="customStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                    <input type="date" id="customEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <button id="updateDateBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                            </button>
                        </div>
                    </div>

                    <div id="uploadContainer" class="hidden">
                         <div id="uploadArea" class="upload-area rounded-lg p-12 text-center cursor-pointer">
                            <div class="flex flex-col items-center">
                                <svg class="w-16 h-16 text-indigo-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-xl text-gray-600 mb-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                                <p class="text-gray-400">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx ‡πÅ‡∏•‡∏∞ .xls</p>
                            </div>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                        </div>
                        <button id="downloadJsonBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (JSON)
                        </button>
                    </div>

                    <div id="fileInfo" class="mt-4 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-green-800 font-medium">‚úÖ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î: <span id="fileName"></span></p>
                            <p class="text-green-600 text-sm mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span id="rowCount"></span> ‡πÅ‡∏ñ‡∏ß</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chartInstances = {};
        let currentData = [];
        let fixedDateRange = null;

        // --- Element References ---
        const uploadToggle = document.getElementById('uploadToggle');
        const uploadContent = document.getElementById('uploadContent');
        const uploadArrow = document.getElementById('uploadArrow');
        const uploadArea = document.getElementById('uploadArea');
        const uploadContainer = document.getElementById('uploadContainer');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const authBtn = document.getElementById('authBtn');
        const authForm = document.getElementById('authForm');
        const authError = document.getElementById('authError');
        const downloadJsonBtn = document.getElementById('downloadJsonBtn'); // ‚≠êÔ∏è ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        let isAuthenticated = false;

        // Toggle upload section
        uploadToggle.addEventListener('click', () => {
            uploadContent.classList.toggle('hidden');
            uploadArrow.classList.toggle('rotate-180');
        });

        // Authentication handling
        authBtn.addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á
            if (username === 'SAT Manager' && password === 'odpc004999') {
                isAuthenticated = true;
                authForm.classList.add('hidden');
                document.getElementById('dateRangeForm').classList.remove('hidden');
                uploadContainer.classList.remove('hidden');
                authError.classList.add('hidden');
                
                // Clear file info when re-authenticating
                document.getElementById('fileInfo').classList.add('hidden');
            } else {
                authError.textContent = 'Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                authError.classList.remove('hidden');
            }
        });
        
        // Enter key support for authentication
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authBtn.click();
            }
        });

        // Date range update handling
        document.getElementById('updateDateBtn').addEventListener('click', () => {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            
            if (startDate && endDate) {
                updateCustomDateRange(startDate, endDate);
                // Store the custom date range
                localStorage.setItem('customStartDate', startDate);
                localStorage.setItem('customEndDate', endDate);
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
            }
        });

        // ‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
        async function loadSharedData() {
try {
    const url = './data/dashboard_data.json?cacheBust=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    console.log('[loadSharedData] fetch', url, res.status);
    if (res.ok) {
      const json = await res.json();
      if (Array.isArray(json)) {
        currentData = json;
        processData(json);
      if (typeof initializeFilters==='function') initializeFilters();
      if (typeof applyFiltersAndRender==='function') applyFiltersAndRender();
        const s = localStorage.getItem('customStartDate');
        const e = localStorage.getItem('customEndDate');
        if (s && e && typeof updateCustomDateRange==='function') updateCustomDateRange(s, e);
        return;
      }
    }
  } catch (err) {
    console.warn('[loadSharedData] shared JSON load failed:', err);
  }
  // Fallbacks:
  try {
    const s = localStorage.getItem('customStartDate');
    const e = localStorage.getItem('customEndDate');
    if (s && e && typeof updateCustomDateRange==='function') updateCustomDateRange(s, e);
    const stored = localStorage.getItem('uploadedData');
    if (stored) {
      const parsed = JSON.parse(stored);
      currentData = parsed;
      processData(parsed);
      if (typeof initializeFilters==='function') initializeFilters();
      if (typeof applyFiltersAndRender==='function') applyFiltersAndRender();
      return;
    }
  } catch (e) { console.warn('localStorage parse fail', e); }
  if (typeof initializeSampleData==='function') initializeSampleData();
}

        
        // ‚≠êÔ∏è ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadSharedData() ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        document.addEventListener('DOMContentLoaded', loadSharedData);

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!isAuthenticated) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå');
                return;
            }

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls)');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            fileInfo.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                document.getElementById('rowCount').textContent = jsonData.length;
                currentData = jsonData;
                
                // Store uploaded data in localStorage
                localStorage.setItem('uploadedData', JSON.stringify(jsonData));
                
                processData(jsonData);
                if (typeof initializeFilters==='function') initializeFilters();
                if (typeof applyFiltersAndRender==='function') applyFiltersAndRender();
                
                // Hide upload section after successful upload
                uploadContent.classList.add('hidden');
                uploadArrow.classList.remove('rotate-180');
            };
            reader.readAsArrayBuffer(file);
        }

        // ‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON
        function downloadCurrentDataAsJson() {
            if (currentData.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
                return;
            }
            
            const dataStr = JSON.stringify(currentData, null, 2); // `null, 2` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement("a");
            link.href = url;
            link.download = "dashboard_data.json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ‚≠êÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        downloadJsonBtn.addEventListener('click', downloadCurrentDataAsJson);

        // Initialize with sample data
        function initializeSampleData() {
            const sampleData = [
                {Event_ID: 'E001', Event_Group: '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list: '‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å', Province_Name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', District_Name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name: '‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å', Place_Type: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', Date_Received: '04-01-2567', Onset: '02-01-2567', case: 25, Death: 0, Priority: '‡∏™‡∏π‡∏á', Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', Investigation: '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E002', Event_Group: '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏©', Province_Name: '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', District_Name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤', Subdistrict_Name: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤', Place_Type: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', Date_Received: '20-02-2567', Onset: '18-02-2567', case: 12, Death: 1, Priority: '‡∏Å‡∏•‡∏≤‡∏á', Status: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', Investigation: '‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß'},
                {Event_ID: 'E003', Event_Group: '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏', Event_list: '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏£‡∏≤‡∏à‡∏£', Province_Name: '‡∏•‡∏≥‡∏û‡∏π‡∏ô', District_Name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name: '‡∏ô‡∏≤‡∏¢‡∏°', Place_Type: '‡∏ñ‡∏ô‡∏ô', Date_Received: '10-03-2567', Onset: '10-03-2567', case: 8, Death: 2, Priority: '‡∏™‡∏π‡∏á', Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', Investigation: '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E004', Event_Group: '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list: '‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î-19', Province_Name: '‡πÅ‡∏û‡∏£‡πà', District_Name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name: '‡πÉ‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Place_Type: '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', Date_Received: '05-04-2567', Onset: '02-04-2567', case: 45, Death: 3, Priority: '‡∏™‡∏π‡∏á', Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', Investigation: '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E005', Event_Group: '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', Event_list: '‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', Province_Name: '‡∏ô‡πà‡∏≤‡∏ô', District_Name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name: '‡πÉ‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Place_Type: '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', Date_Received: '12-05-2567', Onset: '10-05-2567', case: 30, Death: 0, Priority: '‡∏Å‡∏•‡∏≤‡∏á', Status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', Investigation: '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E006', Event_Group: '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list: '‡∏°‡∏∑‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏õ‡∏≤‡∏Å', Province_Name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', District_Name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name: '‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Place_Type: '‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å', Date_Received: '18-06-2567', Onset: '15-06-2567', case: 18, Death: 0, Priority: '‡∏Å‡∏•‡∏≤‡∏á', Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', Investigation: '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E007', Event_Group: '‡πÇ‡∏£‡∏Ñ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list: '‡∏û‡∏¥‡∏©‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', Province_Name: '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', District_Name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name: '‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Place_Type: '‡∏ä‡∏∏‡∏°‡∏ä‡∏ô', Date_Received: '22-07-2567', Onset: '20-07-2567', case: 15, Death: 1, Priority: '‡∏™‡∏π‡∏á', Status: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', Investigation: '‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß'},
                {Event_ID: 'E008', Event_Group: '‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏', Event_list: '‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ', Province_Name: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', District_Name: '‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', Subdistrict_Name: '‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', Place_Type: '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', Date_Received: '14-08-2567', Onset: '14-08-2567', case: 22, Death: 4, Priority: '‡∏™‡∏π‡∏á', Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', Investigation: '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E009', Event_Group: '‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list: '‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà', Province_Name: '‡∏•‡∏≥‡∏õ‡∏≤‡∏á', District_Name: '‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞', Subdistrict_Name: '‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞', Place_Type: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', Date_Received: '08-09-2567', Onset: '05-09-2567', case: 35, Death: 0, Priority: '‡∏Å‡∏•‡∏≤‡∏á', Status: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', Investigation: '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'},
                {Event_ID: 'E010', Event_Group: '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', Event_list: '‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢', Province_Name: '‡∏•‡∏≥‡∏û‡∏π‡∏ô', District_Name: '‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á', Subdistrict_Name: '‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á', Place_Type: '‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥', Date_Received: '06-12-2567', Onset: '04-12-2567', case: 28, Death: 0, Priority: '‡∏Å‡∏•‡∏≤‡∏á', Status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', Investigation: '‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô'}
            ];
            
            currentData = sampleData;
            processData(sampleData);
            if (typeof initializeFilters==='function') initializeFilters();
            if (typeof applyFiltersAndRender==='function') applyFiltersAndRender();
        }

        function processData(data) {
            // Calculate summary statistics
            const totalEvents = data.length;
            const totalCases = data.reduce((sum, row) => sum + (parseInt(row.case) || 0), 0);
            const totalDeaths = data.reduce((sum, row) => sum + (parseInt(row.Death) || 0), 0);
            const uniqueProvinces = [...new Set(data.map(row => row.Province_Name))].length;

            document.getElementById('totalEvents').textContent = totalEvents.toLocaleString();
            document.getElementById('totalCases').textContent = totalCases.toLocaleString();
            document.getElementById('totalDeaths').textContent = totalDeaths.toLocaleString();
            document.getElementById('totalProvinces').textContent = uniqueProvinces;

            //     // Update date range
            updateDateRange(data);

            // Create charts
            createEventListTable(data);
            createEventGroupPieChart(data);
            createProvinceChart(data);
            createTimelineChart(data);
            createPriorityChart(data);
            createStatusChart(data);
            createDataTable(data);
        }

        function updateDateRange(data) {

  try {
    const el = document.getElementById('dataDateRange');
    if (!el) return;
    if (!data || data.length === 0) { el.textContent = '‚Äî'; return; }
    const dates = data.map(r => new Date(r.Date_Received)).filter(d => d instanceof Date && !isNaN(d));
    if (dates.length === 0) { el.textContent = '‚Äî'; return; }
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    const displayStart = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
    const startDateText = formatDate(displayStart);
    const endDateText   = formatDate(maxDate);
    el.textContent = `${startDateText} ‚Äì ${endDateText}`;
  } catch (err) { console.error('updateDateRange error:', err); }

}
            
            // Function to parse Thai Buddhist date format (dd-mm-yyyy) to JavaScript Date
            function parseThaiDate(dateStr) {
                if (!dateStr) return null;
                
                // Handle different date formats
                let day, month, year;
                
                if (dateStr.includes('-')) {
                    // Format: dd-mm-yyyy (Buddhist year)
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                        
                        // Convert Buddhist year to Christian year if needed
                        if (year > 2500) {
                            year = year - 543;
                        }
                        
                        return new Date(year, month - 1, day);
                    }
                } else if (dateStr.includes('/')) {
                    // Format: dd/mm/yyyy
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                        
                        // Convert Buddhist year to Christian year if needed
                        if (year > 2500) {
                            year = year - 543;
                        }
                        
                        return new Date(year, month - 1, day);
                    }
                } else {
                    // Try standard date parsing as fallback
                    const date = new Date(dateStr);
                    return isNaN(date) ? null : date;
                }
                
                return null;
            }
            
            const dates = data.map(row => parseThaiDate(row.Date_Received)).filter(date => date && !isNaN(date));
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                const formatDate = (date) => {
                    const buddhistYear = date.getFullYear() + 543;
                    const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                                  '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                    return `${date.getDate()} ${months[date.getMonth()]} ${buddhistYear}`;
                };
                
                const startDateText = formatDate(minDate);
                const endDateText = formatDate(maxDate);
                
                // Set fixed date range for future use
                fixedDateRange = {
                    start: startDateText,
                    end: endDateText
                };
                
                document.getElementById('startDate').textContent = startDateText;
                document.getElementById('endDate').textContent = endDateText;
            }
        }

        function updateCustomDateRange(startDateStr, endDateStr) {
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                const buddhistYear = date.getFullYear() + 543;
                const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                return `${date.getDate()} ${months[date.getMonth()]} ${buddhistYear}`;
            };
            
            const startDateText = formatDate(startDateStr);
            const endDateText = formatDate(endDateStr);
            
            // Update fixed date range
            fixedDateRange = {
                start: startDateText,
                end: endDateText
            };
            
            document.getElementById('startDate').textContent = startDateText;
            document.getElementById('endDate').textContent = endDateText;
        }

        function createEventListTable(data) {
            const eventCounts = {};
            data.forEach(row => {
                const event = row.Event_list || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                eventCounts[event] = (eventCounts[event] || 0) + 1;
            });

            const total = Object.values(eventCounts).reduce((sum, count) => sum + count, 0);
            const sortedEvents = Object.entries(eventCounts).sort(([,a], [,b]) => b - a);
            const maxCount = Math.max(...sortedEvents.map(([,c]) => c));

            // Update title with total count
            document.getElementById('eventListTitle').textContent = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (N= ${total})`;

            const tableContainer = document.getElementById('eventListTable');
            let tableHTML = `
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            sortedEvents.forEach(([event, count], index) => {
                const percentage = ((count / total) * 100).toFixed(1);
                // Calculate green intensity based on count (darker for higher values)
                const intensity = count / maxCount;
                const greenValue = Math.round(255 - (intensity * 100)); // From 255 (light) to 155 (dark)
                const backgroundColor = `rgba(34, ${greenValue}, 34, ${0.1 + (intensity * 0.4)})`; // Green gradient
                
                tableHTML += `
                    <tr style="background-color: ${backgroundColor};">
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${index + 1}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${event}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-center font-bold">${count.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 text-center font-medium">${percentage}%</td>
                    </tr>
                `;
            });

            // Add summary row
            tableHTML += `
                    <tr class="bg-blue-50 border-t-2 border-blue-200">
                        <td class="px-4 py-3 text-sm font-bold text-blue-900" colspan="2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                        <td class="px-4 py-3 text-sm font-bold text-blue-900 text-center">${total.toLocaleString()}</td>
                        <td class="px-4 py-3 text-sm font-bold text-blue-900 text-center">100.0%</td>
                    </tr>
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        function createEventGroupPieChart(data) {
            const groupCounts = {};
            data.forEach(row => {
                const group = row.Event_Group || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                groupCounts[group] = (groupCounts[group] || 0) + 1;
            });

            const total = Object.values(groupCounts).reduce((sum, count) => sum + count, 0);
            const sortedGroups = Object.entries(groupCounts).sort(([,a], [,b]) => b - a);

            // Update title with total count
            document.getElementById('eventGroupTitle').textContent = `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (N= ${total})`;

            const ctx = document.getElementById('eventGroupPieChart').getContext('2d');
            if (chartInstances.eventGroupPie) chartInstances.eventGroupPie.destroy();
            
            chartInstances.eventGroupPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sortedGroups.map(([name]) => name),
                    datasets: [{
                        data: sortedGroups.map(([,count]) => count),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Blue
                            'rgba(16, 185, 129, 0.8)',   // Green  
                            'rgba(245, 101, 101, 0.8)',  // Red
                            'rgba(139, 92, 246, 0.8)',   // Purple
                            'rgba(251, 191, 36, 0.8)',   // Yellow
                            'rgba(236, 72, 153, 0.8)',   // Pink
                            'rgba(20, 184, 166, 0.8)',   // Teal
                            'rgba(249, 115, 22, 0.8)',   // Orange
                            'rgba(107, 114, 128, 0.8)',  // Gray
                            'rgba(34, 197, 94, 0.8)'     // Emerald
                        ],
                        borderColor: '#fff',
                        borderWidth: 3,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { family: 'Sarabun', size: 12 },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const count = context.parsed;
                                    const percentage = ((count / total) * 100).toFixed(1);
                                    return `${context.label}: ${count.toLocaleString()} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${percentage}%)`;
                                }
                            },
                            titleFont: { family: 'Sarabun', size: 14 },
                            bodyFont: { family: 'Sarabun', size: 13 }
                        }
                    }
                }
            });
        }

        function createProvinceChart(data) {
            const provinceCounts = {};
            data.forEach(row => {
                const province = row.Province_Name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                provinceCounts[province] = (provinceCounts[province] || 0) + 1;
            });

            const total = Object.values(provinceCounts).reduce((sum, count) => sum + count, 0);
            const sortedProvinces = Object.entries(provinceCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            // Update title with total count
            document.getElementById('provinceTitle').textContent = `‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (N= ${total})`;

            const ctx = document.getElementById('provinceChart').getContext('2d');
            if (chartInstances.province) chartInstances.province.destroy();
            
            chartInstances.province = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProvinces.map(([name]) => name),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
                        data: sortedProvinces.map(([,count]) => count),
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const count = context.parsed.x;
                                    const percentage = ((count / total) * 100).toFixed(1);
                                    return `${context.label}: ${count.toLocaleString()} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${percentage}%)`;
                                }
                            },
                            titleFont: { family: 'Sarabun', size: 14 },
                            bodyFont: { family: 'Sarabun', size: 13 }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { 
                                font: { family: 'Sarabun', size: 12 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            ticks: { font: { family: 'Sarabun', size: 12 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createTimelineChart(data) {
            const monthCounts = {};
            
            // Function to parse Thai Buddhist date format (dd-mm-yyyy) to JavaScript Date
            function parseThaiDate(dateStr) {
                if (!dateStr) return null;
                
                // Handle different date formats
                let day, month, year;
                
                if (dateStr.includes('-')) {
                    // Format: dd-mm-yyyy (Buddhist year)
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                        
                        // Convert Buddhist year to Christian year if needed
                        if (year > 2500) {
                            year = year - 543;
                        }
                        
                        // Create date in dd/mm/yyyy format for processing
                        return new Date(year, month - 1, day);
                    }
                } else if (dateStr.includes('/')) {
                    // Format: dd/mm/yyyy
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                        
                        // Convert Buddhist year to Christian year if needed
                        if (year > 2500) {
                            year = year - 543;
                        }
                        
                        return new Date(year, month - 1, day);
                    }
                } else {
                    // Try standard date parsing as fallback
                    const date = new Date(dateStr);
                    return isNaN(date) ? null : date;
                }
                
                return null;
            }
            
            // Count valid dates only
            let validDateCount = 0;
            let minYear = Infinity;
            let maxYear = -Infinity;
            
            data.forEach(row => {
                if (row.Date_Received) {
                    const date = parseThaiDate(row.Date_Received);
                    if (date && !isNaN(date)) {
                        validDateCount++;
                        const year = date.getFullYear();
                        minYear = Math.min(minYear, year);
                        maxYear = Math.max(maxYear, year);
                        const monthKey = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                    }
                }
            });

            // Create complete month range for all years
            const allMonths = [];
            if (minYear !== Infinity && maxYear !== -Infinity) {
                for (let year = minYear; year <= maxYear; year++) {
                    for (let month = 1; month <= 12; month++) {
                        const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                        allMonths.push(monthKey);
                        // Initialize with 0 if no data exists
                        if (!monthCounts[monthKey]) {
                            monthCounts[monthKey] = 0;
                        }
                    }
                }
            }

            // Use total data length for accurate count display
            const total = data.length;
            // Update title with total count
            document.getElementById('timelineTitle').textContent = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (N= ${total})`;

            const sortedMonths = allMonths.sort().map(monthKey => [monthKey, monthCounts[monthKey] || 0]);
            const labels = sortedMonths.map(([monthKey]) => {
                const [year, month] = monthKey.split('-');
                const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                                  '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });

            // Create single dataset with all data points (including zeros)
            const allData = sortedMonths.map(([monthKey, count], index) => ({
                x: index,
                y: count
            }));

            const ctx = document.getElementById('timelineChart').getContext('2d');
            if (chartInstances.timeline) chartInstances.timeline.destroy();
            
            chartInstances.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                            data: allData,
                            borderColor: 'rgba(139, 92, 246, 1)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 4,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: function(context) {
                                const value = context.parsed.y;
                                return value === 0 ? 'rgba(139, 92, 246, 0.4)' : 'rgba(139, 92, 246, 1)';
                            },
                            pointBorderColor: '#fff',
                            pointBorderWidth: 3,
                            pointRadius: function(context) {
                                const value = context.parsed.y;
                                return value === 0 ? 4 : 6;
                            },
                            pointHoverRadius: 8,
                            segment: {
                                borderDash: function(ctx) {
                                    // Create dashed line for segments where both points are zero
                                    const p0 = ctx.p0.parsed.y;
                                    const p1 = ctx.p1.parsed.y;
                                    return (p0 === 0 && p1 === 0) ? [8, 8] : undefined;
                                },
                                borderColor: function(ctx) {
                                    // Make line lighter for zero-value segments
                                    const p0 = ctx.p0.parsed.y;
                                    const p1 = ctx.p1.parsed.y;
                                    return (p0 === 0 && p1 === 0) ? 'rgba(139, 92, 246, 0.4)' : 'rgba(139, 92, 246, 1)';
                                }
                            },
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const count = context.parsed.y;
                                    return `${context.label}: ${count} ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå`;
                                }
                            },
                            titleFont: { family: 'Sarabun', size: 14 },
                            bodyFont: { family: 'Sarabun', size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                font: { family: 'Sarabun', size: 12 },
                                stepSize: 1,
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : '';
                                }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        x: {
                            ticks: { 
                                font: { family: 'Sarabun', size: 12 },
                                maxRotation: 45
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    }
                }
            });
        }

        function createPriorityChart(data) {

  const priorityCounts = {};
  data.forEach(r => {
    const name = (r.Priority || r.priority || r['‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß'] || '').toString().trim();
    if (!name) return;
    priorityCounts[name] = (priorityCounts[name] || 0) + 1;
  });
  const sorted = Object.entries(priorityCounts).sort(([,a],[,b]) => b - a);
  const labels = sorted.map(([name]) => name);
  const values = sorted.map(([,count]) => count);
  const total  = values.reduce((s,v)=>s+v,0);
  const titleEl = document.getElementById('priorityTitle');
  if (titleEl) titleEl.textContent = `‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß (N= ${total})`;

  function generatePalette(n, alpha = 0.85) {
    const out = [];
    const golden = 0.618033988749895;
    let h = 0.13;
    for (let i = 0; i < n; i++) {
      h = (h + golden) % 1;
      const s = 0.70, l = 0.50;
      out.push({
        fill:  `hsla(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%, ${alpha})`,
        stroke:`hsla(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%, 1)`
      });
    }
    return out;
  }
  const palette = generatePalette(labels.length);

  if (!window.chartInstances) window.chartInstances = {};
  if (window.chartInstances.priority) {
    try { window.chartInstances.priority.destroy(); } catch(e) {}
  }
  const ctx = document.getElementById('priorityChart')?.getContext('2d');
  if (!ctx) return;

  window.chartInstances.priority = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)',
        data: values,
        backgroundColor: palette.map(c => c.fill),
        borderColor:     palette.map(c => c.stroke),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          labels: {
            generateLabels: function(chart) {
              return labels.map((name, idx) => ({
                text: `${name} (${values[idx]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`,
                fillStyle:  palette[idx]?.fill  || 'rgba(59,130,246,0.8)',
                strokeStyle:palette[idx]?.stroke|| 'rgba(59,130,246,1)',
                lineWidth: 2
              }));
            }
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.parsed.y.toLocaleString()} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            font: { family: 'Sarabun', size: 14, weight: 'bold' },
            color: function(t) {
              const i = t.index ?? 0;
              return palette[i]?.stroke || '#111827';
            }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => v.toLocaleString()
          }
        }
      }
    }
  });

};
            data.forEach(row => {
                const priority = row.Priority || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                priorityCounts[priority] = (priorityCounts[priority] || 0) + 1;
            });

            const total = Object.values(priorityCounts).reduce((sum, count) => sum + count, 0);
            const sortedPriorities = Object.entries(priorityCounts).sort(([,a], [,b]) => b - a);

            // Update title with total count
            document.getElementById('priorityTitle').textContent = `‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß (N= ${total})`;

            // Create color mapping for priorities
            const colorMap = {
                '‡∏™‡∏π‡∏á': 'rgba(239, 68, 68, 0.8)',      // Red
                '‡∏Å‡∏•‡∏≤‡∏á': 'rgba(245, 158, 11, 0.8)',    // Orange
                '‡∏ï‡πà‡∏≥': 'rgba(34, 197, 94, 0.8)',      // Green
                '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏': 'rgba(156, 163, 175, 0.8)' // Gray
            };

            const ctx = document.getElementById('priorityChart').getContext('2d');
            if (chartInstances.priority) chartInstances.priority.destroy();
            
            chartInstances.priority = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedPriorities.map(([name]) => '‚óè'), // Use colored dots instead of text
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
                        data: sortedPriorities.map(([,count]) => count),
                        backgroundColor: sortedPriorities.map(([name]) => colorMap[name] || 'rgba(59, 130, 246, 0.8)'),
                        borderColor: sortedPriorities.map(([name]) => colorMap[name]?.replace('0.8', '1') || 'rgba(59, 130, 246, 1)'),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    return sortedPriorities.map(([name], index) => ({
                                        text: `${name} (${sortedPriorities[index][1]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`,
                                        fillStyle: colorMap[name] || 'rgba(59, 130, 246, 0.8)',
                                        strokeStyle: colorMap[name]?.replace('0.8', '1') || 'rgba(59, 130, 246, 1)',
                                        lineWidth: 2,
                                        pointStyle: 'rect'
                                    }));
                                },
                                font: { family: 'Sarabun', size: 12 },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return sortedPriorities[index][0];
                                },
                                label: function(context) {
                                    const count = context.parsed.y;
                                    const percentage = ((count / total) * 100).toFixed(1);
                                    return `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${count.toLocaleString()} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${percentage}%)`;
                                }
                            },
                            titleFont: { family: 'Sarabun', size: 14 },
                            bodyFont: { family: 'Sarabun', size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                font: { family: 'Sarabun', size: 12 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        x: {
                            ticks: { 
                                font: { family: 'Sarabun', size: 16, weight: 'bold' },
                                color: function(context) {
                                    const index = context.index;
                                    const name = sortedPriorities[index][0];
                                    return colorMap[name]?.replace('0.8', '1') || 'rgba(59, 130, 246, 1)';
                                }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createStatusChart(data) {
            const statusCounts = {};
            data.forEach(row => {
                const status = row.Status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const total = Object.values(statusCounts).reduce((sum, count) => sum + count, 0);
            const sortedStatuses = Object.entries(statusCounts).sort(([,a], [,b]) => b - a);

            // Update title with total count
            document.getElementById('statusTitle').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (N= ${total})`;

            const ctx = document.getElementById('statusChart').getContext('2d');
            if (chartInstances.status) chartInstances.status.destroy();
            
            chartInstances.status = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedStatuses.map(([name]) => name),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
                        data: sortedStatuses.map(([,count]) => count),
                        backgroundColor: [
                            'rgba(20, 184, 166, 0.8)',  // Teal - Completed
                            'rgba(251, 191, 36, 0.8)',  // Yellow - In progress
                            'rgba(239, 68, 68, 0.8)',   // Red - Pending
                            'rgba(139, 92, 246, 0.8)',  // Purple - Under review
                            'rgba(156, 163, 175, 0.8)'  // Gray - Unknown
                        ],
                        borderColor: [
                            'rgba(20, 184, 166, 1)',
                            'rgba(251, 191, 36, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(156, 163, 175, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const count = context.parsed.y;
                                    const percentage = ((count / total) * 100).toFixed(1);
                                    return `${context.label}: ${count.toLocaleString()} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${percentage}%)`;
                                }
                            },
                            titleFont: { family: 'Sarabun', size: 14 },
                            bodyFont: { family: 'Sarabun', size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                font: { family: 'Sarabun', size: 12 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        x: {
                            ticks: { 
                                font: { family: 'Sarabun', size: 12 },
                                maxRotation: 45
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createDataTable(data) {
            const table = document.getElementById('dataTable');
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');

            // Clear existing content
            header.innerHTML = '';
            body.innerHTML = '';

            if (data.length === 0) return;

            // Create header
            const columns = Object.keys(data[0]);
            columns.forEach(col => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b';
                th.textContent = col;
                header.appendChild(th);
            });

            // Create rows (show last 10 rows)
            data.slice(-10).reverse().forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 text-sm text-gray-900 border-b';
                    td.textContent = row[col] || '-';
                    tr.appendChild(td);
                });
                
                body.appendChild(tr);
            });

            if (data.length > 10) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = columns.length;
                td.className = 'px-4 py-3 text-center text-sm text-gray-500 italic';
                td.textContent = `‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡πÅ‡∏ñ‡∏ß`;
                tr.appendChild(td);
                body.appendChild(tr);
            }
        }
    
        // ====== Filtering Utilities (Province->District->Subdistrict + Event Group/List) ======
        const selProvince = document.getElementById('filterProvince');
        const selDistrict = document.getElementById('filterDistrict');
        const selSubdistrict = document.getElementById('filterSubdistrict');
        const selGroup = document.getElementById('filterGroup');
        const selEvent = document.getElementById('filterEvent');
        const btnResetFilters = document.getElementById('resetFilters');

        function uniqueSorted(arr){
            return [...new Set(arr.filter(v => v !== undefined && v !== null && (''+v).trim() !== ''))]
                    .map(v => (''+v).trim())
                    .sort((a,b)=>a.localeCompare(b,'th'));
        }

        function initializeFilters(){
            // Populate all selects based on currentData
            populateProvinceOptions();
            populateGroupOptions();
            populateEventOptions(); // initial (all events)

            // Bind events
            selProvince.addEventListener('change', () => {
                populateDistrictOptions();
                populateSubdistrictOptions(true);
                applyFiltersAndRender();
            });
            selDistrict.addEventListener('change', () => {
                populateSubdistrictOptions();
                applyFiltersAndRender();
            });
            selSubdistrict.addEventListener('change', applyFiltersAndRender);

            selGroup.addEventListener('change', () => {
                populateEventOptions();
                applyFiltersAndRender();
            });
            selEvent.addEventListener('change', applyFiltersAndRender);

            btnResetFilters.addEventListener('click', resetFilters);
        }

        function resetFilters(){
            selProvince.value = '';
            selDistrict.innerHTML = '<option value=\"\">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>';
            selDistrict.disabled = true;
            selDistrict.classList.add('bg-gray-50','text-gray-500');

            selSubdistrict.innerHTML = '<option value=\"\">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>';
            selSubdistrict.disabled = true;
            selSubdistrict.classList.add('bg-gray-50','text-gray-500');

            selGroup.value = '';
            populateEventOptions(); // resets to all
            selEvent.value = '';

            applyFiltersAndRender();
        }

        function populateProvinceOptions(){
            const vals = uniqueSorted(currentData.map(r => r.Province_Name));
            selProvince.innerHTML = '<option value=\"\">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + vals.map(v=>`<option>${v}</option>`).join('');
        }

        function populateDistrictOptions(){
            const province = selProvince.value;
            if(!province){
                selDistrict.disabled = true;
                selDistrict.classList.add('bg-gray-50','text-gray-500');
                selDistrict.innerHTML = '<option value=\"\">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>';
                return;
            }
            const vals = uniqueSorted(currentData.filter(r => r.Province_Name===province).map(r => r.District_Name));
            selDistrict.disabled = false;
            selDistrict.classList.remove('bg-gray-50','text-gray-500');
            selDistrict.innerHTML = '<option value=\"\">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + vals.map(v=>`<option>${v}</option>`).join('');
        }

        function populateSubdistrictOptions(forceReset=false){
            const province = selProvince.value;
            const district = selDistrict.value;
            if(!province){
                selSubdistrict.disabled = true;
                selSubdistrict.classList.add('bg-gray-50','text-gray-500');
                selSubdistrict.innerHTML = '<option value=\"\">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>';
                return;
            }
            if(!district){
                // lock until district chosen (strict cascading)
                selSubdistrict.disabled = true;
                selSubdistrict.classList.add('bg-gray-50','text-gray-500');
                selSubdistrict.innerHTML = '<option value=\"\">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡πà‡∏≠‡∏ô ‚Äî</option>';
                return;
            }
            const vals = uniqueSorted(currentData.filter(r => r.Province_Name===province && r.District_Name===district).map(r => r.Subdistrict_Name));
            selSubdistrict.disabled = false;
            selSubdistrict.classList.remove('bg-gray-50','text-gray-500');
            selSubdistrict.innerHTML = '<option value=\"\">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + vals.map(v=>`<option>${v}</option>`).join('');
            if(forceReset) selSubdistrict.value = '';
        }

        function populateGroupOptions(){
            const vals = uniqueSorted(currentData.map(r => r.Event_Group));
            selGroup.innerHTML = '<option value=\"\">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + vals.map(v=>`<option>${v}</option>`).join('');
        }

        function populateEventOptions(){
            // If a group is selected, only show events in that group for usability.
            const g = selGroup.value;
            let pool = currentData;
            if(g) pool = currentData.filter(r => r.Event_Group===g);
            const vals = uniqueSorted(pool.map(r => r.Event_list));
            selEvent.innerHTML = '<option value=\"\">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + vals.map(v=>`<option>${v}</option>`).join('');
        }

        function getFilteredData(){
            const p = selProvince.value;
            const d = selDistrict.value;
            const s = selSubdistrict.value;
            const g = selGroup.value;
            const e = selEvent.value;
            let data = currentData.slice();

            if(p) data = data.filter(r => r.Province_Name===p);
            if(d) data = data.filter(r => r.District_Name===d);
            if(s) data = data.filter(r => r.Subdistrict_Name===s);
            if(g) data = data.filter(r => r.Event_Group===g);
            if(e) data = data.filter(r => r.Event_list===e);
            return data;
        }

        function applyFiltersAndRender(){
            const filtered = getFilteredData();
            processData(filtered);
        }

    </script>

<!-- SUN minimal exports & chart title utilities -->
<script>
(function(){
  function ensureXLSX(cb){
    if (window.XLSX && XLSX.utils && XLSX.writeFile) { cb(); return; }
    var s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload=cb; document.head.appendChild(s);
  }
  function titleOf(canvas){
    let t = canvas.getAttribute('data-title') || canvas.getAttribute('aria-label') || '';
    const card = canvas.closest('.bg-white');
    const h = card && card.querySelector('h1,h2,h3,.text-2xl,.text-xl,.text-lg');
    if (h && h.textContent) t = h.textContent.trim();
    return t || (canvas.id || 'Chart');
  }
  function composeWithTitle(canvas, t){
    const dpr = window.devicePixelRatio || 1, pad=12, tp=18, titleArea=Math.round((tp+pad*2)*dpr);
    const out=document.createElement('canvas'); out.width=canvas.width; out.height=canvas.height+titleArea;
    const c=out.getContext('2d'); c.fillStyle='#fff'; c.fillRect(0,0,out.width,out.height);
    c.fillStyle='#111827'; c.font=`${Math.round(tp*dpr)}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;
    c.textBaseline='top'; c.textAlign='left'; c.fillText(t, Math.round(pad*dpr), Math.round(pad*dpr));
    c.drawImage(canvas, 0, titleArea); return out;
  }
  function downloadPNGWithTitle(canvas, fname){
    const out = composeWithTitle(canvas, titleOf(canvas));
    const a=document.createElement('a'); a.href=out.toDataURL('image/png'); a.download=fname||((canvas.id||'chart')+'.png');
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
  async function copyPNGWithTitle(canvas){
    try{
      if (!navigator.clipboard || typeof ClipboardItem==='undefined') throw new Error('no clipboard api');
      const out = composeWithTitle(canvas, titleOf(canvas));
      const blob = await new Promise(r=>out.toBlob(r,'image/png'));
      await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
      alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏≤‡∏ü (‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠) ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    }catch(e){
      downloadPNGWithTitle(canvas, (canvas.id||'chart')+'.png');
    }
  }
  function addChartToolbar(id){
    const cv=document.getElementById(id); if(!cv) return;
    const card=cv.closest('.bg-white.rounded-xl.card-shadow')||cv.closest('.bg-white')||cv.parentElement;
    if(!card) return;
    if(card.querySelector('[data-sun-toolbar="'+id+'"]')) return;
    const header = card.querySelector('.flex.items-center.mb-6, .flex.items-center.justify-between');
    const bar=document.createElement('div'); bar.className='ml-auto flex items-center gap-2'; bar.setAttribute('data-sun-toolbar', id);
    const b1=document.createElement('button'); b1.type='button'; b1.className='px-3 py-1.5 text-xs rounded-lg bg-gray-100 hover:bg-gray-200'; b1.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Å‡∏£‡∏≤‡∏ü';
    b1.addEventListener('click',()=>copyPNGWithTitle(cv));
    const b2=document.createElement('button'); b2.type='button'; b2.className='px-3 py-1.5 text-xs rounded-lg bg-gray-100 hover:bg-gray-200'; b2.textContent='‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PNG';
    b2.addEventListener('click',()=>downloadPNGWithTitle(cv, id+'.png'));
    bar.appendChild(b1); bar.appendChild(b2);
    (header||card).appendChild(bar);
  }
  function injectChartToolbars(){
    ['timelineChart','eventGroupPieChart','provinceChart','priorityChart','statusChart'].forEach(addChartToolbar);
  }
  function exportTableToExcel(tbl, filename){
    ensureXLSX(function(){
      try{
        const wb = XLSX.utils.table_to_book(tbl, {sheet:'Table'});
        XLSX.writeFile(wb, filename||'table.xlsx');
      }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡πÑ‡∏î‡πâ'); }
    });
  }
  function exportCurrentDataToExcel(filename){
    ensureXLSX(function(){
      try{
        if(!Array.isArray(window.currentData)||!window.currentData.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
        const ws=XLSX.utils.json_to_sheet(window.currentData);
        const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Data'); XLSX.writeFile(wb, filename||'dashboard_data.xlsx');
      }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡πÑ‡∏î‡πâ'); }
    });
  }
  function insertMainTableButtons(){
    const header=document.querySelector('#dataTableSection .flex.items-center.justify-between');
    const tbl=document.getElementById('dataTable'); if(!header||!tbl) return;
    if(header.querySelector('[data-sun-mainexcel]')) return;
    const box=document.createElement('div'); box.className='flex items-center gap-2'; box.setAttribute('data-sun-mainexcel','1');
    const x1=document.createElement('button'); x1.type='button'; x1.className='px-3 py-1.5 text-sm rounded-lg bg-gray-100 hover:bg-gray-200'; x1.textContent='‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Excel)';
    x1.addEventListener('click',()=>exportTableToExcel(tbl,'table_display.xlsx'));
    const x2=document.createElement('button'); x2.type='button'; x2.className='px-3 py-1.5 text-sm rounded-lg bg-emerald-100 hover:bg-emerald-200'; x2.textContent='‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Excel)';
    x2.addEventListener('click',()=>exportCurrentDataToExcel('dashboard_data.xlsx'));
    box.appendChild(x1); box.appendChild(x2); header.appendChild(box);
  }
  function insertEventListExcelButton(){
    const tbl=document.getElementById('eventListTable'); if(!tbl) return;
    const card=tbl.closest('.bg-white')||tbl.parentElement; if(!card) return;
    let header=card.querySelector('.flex.items-center.justify-between');
    if(!header){ header=document.createElement('div'); header.className='flex items-center justify-between mb-4'; card.insertBefore(header, card.firstChild); }
    if(header.querySelector('[data-sun-eventexcel]')) return;
    const box=document.createElement('div'); box.className='flex items-center gap-2'; box.setAttribute('data-sun-eventexcel','1');
    const btn=document.createElement('button'); btn.type='button'; btn.className='px-3 py-1.5 text-sm rounded-lg bg-gray-100 hover:bg-gray-200'; btn.textContent='‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Excel)';
    btn.addEventListener('click',()=>exportTableToExcel(tbl,'event_list.xlsx'));
    box.appendChild(btn); header.appendChild(box);
  }
  function removeCSVButtons(){
    document.querySelectorAll('button').forEach(b=>{
      const t=(b.textContent||'').toLowerCase();
      if(t.includes('csv')) b.remove();
    });
  }
  function boot(){
    removeCSVButtons();
    injectChartToolbars();
    insertMainTableButtons();
    insertEventListExcelButton();
  }
  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
<!-- /SUN minimal -->

</body>
</html>
