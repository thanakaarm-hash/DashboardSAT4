<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - ‡πÄ‡∏Ç‡∏ï‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4 (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .select { @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white; }
  </style>
</head>
<body class="bg-gray-50">
  <header class="gradient-bg text-white py-6 shadow-lg">
    <div class="container mx-auto px-6">
      <h1 class="text-3xl font-bold text-center">üè• Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>
      <p class="text-center text-blue-100 mt-2 text-lg">‡πÄ‡∏Ç‡∏ï‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4 ‚Ä¢ ‡∏ó‡∏µ‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå (SAT)</p>
      <div class="text-center mt-4 text-blue-100">
        <p id="dataDateRange" class="text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="startDate">-</span> ‡∏ñ‡∏∂‡∏á <span id="endDate">-</span></p>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-6 py-8">
    <!-- üîé FILTER BAR -->
    <div id="filterBar" class="bg-white rounded-xl card-shadow p-6 mb-8 border-l-4 border-indigo-500">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <div class="flex gap-2">
          <button id="clearFilters" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
          <button id="applyFilters" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
          <select id="provinceSelect" class="select"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
          <select id="districtSelect" class="select"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡∏ö‡∏•</label>
          <select id="subdistrictSelect" class="select"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</label>
          <select id="groupSelect" class="select"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</label>
          <select id="eventSelect" class="select"></select>
        </div>
      </div>

      <p id="activeFilterText" class="text-sm text-gray-500 mt-3"></p>
    </div>

    <!-- SUMMARY CARDS -->
    <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-700 rounded-xl p-6 text-white card-shadow">
        <p class="text-blue-100 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <p id="totalEvents" class="text-3xl font-bold">-</p>
      </div>
      <div class="bg-gradient-to-br from-emerald-500 via-green-600 to-teal-700 rounded-xl p-6 text-white card-shadow">
        <p class="text-green-100 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°</p>
        <p id="totalCases" class="text-3xl font-bold">-</p>
      </div>
      <div class="bg-gradient-to-br from-red-500 via-rose-600 to-pink-700 rounded-xl p-6 text-white card-shadow">
        <p class="text-red-100 text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</p>
        <p id="totalDeaths" class="text-3xl font-bold">-</p>
      </div>
      <div class="bg-gradient-to-br from-purple-500 via-violet-600 to-indigo-700 rounded-xl p-6 text-white card-shadow">
        <p class="text-purple-100 text-sm font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</p>
        <p id="totalProvinces" class="text-3xl font-bold">-</p>
      </div>
    </div>

    <!-- CHARTS -->
    <div id="chartsSection">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-indigo-500">
          <div class="flex items-center mb-6">
            <h3 id="eventGroupTitle" class="text-xl font-semibold text-gray-800">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
          </div>
          <div class="h-96">
            <canvas id="eventGroupPieChart"></canvas>
          </div>
        </div>

        <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-blue-500">
          <div class="flex items-center mb-6">
            <h3 id="eventListTitle" class="text-xl font-semibold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
          </div>
          <div class="h-96 overflow-y-auto">
            <div id="eventListTable"></div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl card-shadow p-8 mb-8 border-l-4 border-green-500">
        <div class="flex items-center mb-6">
          <h3 id="provinceTitle" class="text-xl font-semibold text-gray-800">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h3>
        </div>
        <div class="h-96">
          <canvas id="provinceChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-xl card-shadow p-8 mb-8 border-l-4 border-purple-500">
        <div class="flex items-center mb-6">
          <h3 id="timelineTitle" class="text-xl font-semibold text-gray-800">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤</h3>
        </div>
        <div class="h-96">
          <canvas id="timelineChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-orange-500">
          <div class="flex items-center mb-6">
            <h3 id="priorityTitle" class="text-xl font-semibold text-gray-800">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß</h3>
          </div>
          <div class="h-80"><canvas id="priorityChart"></canvas></div>
        </div>

        <div class="bg-white rounded-xl card-shadow p-8 border-l-4 border-teal-500">
          <div class="flex items-center mb-6">
            <h3 id="statusTitle" class="text-xl font-semibold text-gray-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
          </div>
          <div class="h-80"><canvas id="statusChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- DATA TABLE -->
    <div id="dataTableSection" class="bg-white rounded-xl card-shadow p-8 mt-8 border-l-4 border-gray-500">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
          <p class="text-gray-600 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</p>
        </div>
        <div class="flex gap-2">
          <button id="exportTableExcel" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Excel)</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full table-auto">
          <thead class="bg-gray-50"><tr id="tableHeader"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- UPLOAD & JSON DOWNLOAD (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠) -->
    <div class="mt-8">
      <div class="bg-white rounded-xl card-shadow border-l-4 border-indigo-500 overflow-hidden">
        <div class="p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx/.xls)</label>
              <input type="file" id="fileInput" accept=".xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded-lg"/>
              <p class="text-xs text-gray-500 mt-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: Event_ID, Event_Group, Event_list, Province_Name, District_Name, Subdistrict_Name, Date_Received, case, Death, Priority, Status</p>
            </div>
            <div class="flex items-end gap-2">
              <button id="downloadJsonBtn" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (JSON)</button>
              <span id="rowCountLabel" class="text-sm text-gray-600"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <script>
    let chartInstances = {};
    let currentData = [];
    let fixedDateRange = null;

    // ------- Utilities -------
    function uniq(arr){ return [...new Set(arr.filter(v => v !== undefined && v !== null && v !== ''))]; }
    function by(a,b){ return a.localeCompare(b, 'th'); }
    function fmtInt(n){ return (n ?? 0).toLocaleString(); }

    // Parse Thai Buddhist date "dd-mm-yyyy" or "dd/mm/yyyy" to Date
    function parseThaiDate(dateStr) {
      if (!dateStr) return null;
      let d,m,y;
      if (dateStr.includes('-') || dateStr.includes('/')){
        const parts = dateStr.split(dateStr.includes('-') ? '-' : '/');
        if (parts.length === 3){
          d = parseInt(parts[0]); m = parseInt(parts[1]); y = parseInt(parts[2]);
          if (y > 2500) y -= 543;
          return new Date(y, m-1, d);
        }
      }
      const t = new Date(dateStr);
      return isNaN(t) ? null : t;
    }

    function updateDateRange(data) {
      if (fixedDateRange){
        document.getElementById('startDate').textContent = fixedDateRange.start;
        document.getElementById('endDate').textContent = fixedDateRange.end;
        return;
      }
      const dates = data.map(r => parseThaiDate(r.Date_Received)).filter(d => d && !isNaN(d));
      if (dates.length){
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
        const fmt = (dt)=> `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear()+543}`;
        document.getElementById('startDate').textContent = fmt(minDate);
        document.getElementById('endDate').textContent = fmt(maxDate);
      }
    }

    // ------- Filters -------
    const provinceSel = document.getElementById('provinceSelect');
    const districtSel = document.getElementById('districtSelect');
    const subdistrictSel = document.getElementById('subdistrictSelect');
    const groupSel = document.getElementById('groupSelect');
    const eventSel = document.getElementById('eventSelect');
    const activeFilterText = document.getElementById('activeFilterText');

    function setOptions(select, values, placeholder){
      const val = select.value;
      select.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = ''; opt0.textContent = placeholder || '‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî';
      select.appendChild(opt0);
      values.forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        select.appendChild(o);
      });
      // restore if still valid
      if (values.includes(val)) select.value = val;
    }

    function populateFilters(data){
      const provinces = uniq(data.map(r => r.Province_Name)).sort(by);
      const groups = uniq(data.map(r => r.Event_Group)).sort(by);
      const events = uniq(data.map(r => r.Event_list)).sort(by);

      // Cascade logic based on current selections
      const selProv = provinceSel.value || '';
      const selDist = districtSel.value || '';
      const selSubd = subdistrictSel.value || '';
      const selGroup = groupSel.value || '';

      // districts limited by province if selected
      const districts = uniq(data.filter(r => !selProv || r.Province_Name === selProv).map(r => r.District_Name)).sort(by);
      // subdistricts limited by district if selected (and province if selected)
      const subdistricts = uniq(
        data.filter(r =>
          (!selProv || r.Province_Name === selProv) &&
          (!selDist || r.District_Name === selDist)
        ).map(r => r.Subdistrict_Name)
      ).sort(by);

      // event list limited by group if selected
      const eventsLimited = uniq(
        data.filter(r => !selGroup || r.Event_Group === selGroup).map(r => r.Event_list)
      ).sort(by);

      setOptions(provinceSel, provinces, '‚Äî ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Äî');
      setOptions(districtSel, districts, '‚Äî ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Äî');
      setOptions(subdistrictSel, subdistricts, '‚Äî ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏• ‚Äî');
      setOptions(groupSel, groups, '‚Äî ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ ‚Äî');
      setOptions(eventSel, eventsLimited, '‚Äî ‡∏ó‡∏∏‡∏Å‡πÇ‡∏£‡∏Ñ/‡∏†‡∏±‡∏¢ ‚Äî');

      renderActiveFilterText();
    }

    function renderActiveFilterText(){
      const tokens = [];
      if (provinceSel.value) tokens.push(`‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${provinceSel.value}`);
      if (districtSel.value) tokens.push(`‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: ${districtSel.value}`);
      if (subdistrictSel.value) tokens.push(`‡∏ï‡∏≥‡∏ö‡∏•: ${subdistrictSel.value}`);
      if (groupSel.value) tokens.push(`‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ: ${groupSel.value}`);
      if (eventSel.value) tokens.push(`‡πÇ‡∏£‡∏Ñ/‡∏†‡∏±‡∏¢: ${eventSel.value}`);
      activeFilterText.textContent = tokens.length ? `‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ${tokens.join(' ‚Ä¢ ')}` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)';
    }

    function getFilteredData(){
      return currentData.filter(r =>
        (!provinceSel.value || r.Province_Name === provinceSel.value) &&
        (!districtSel.value || r.District_Name === districtSel.value) &&
        (!subdistrictSel.value || r.Subdistrict_Name === subdistrictSel.value) &&
        (!groupSel.value || r.Event_Group === groupSel.value) &&
        (!eventSel.value || r.Event_list === eventSel.value)
      );
    }

    // ------- Data load (sample or from JSON/Excel) -------
    async function loadSharedData(){
      // Try shared JSON (if hosted)
      try{
        const url = './data/dashboard_data.json?cacheBust=' + Date.now();
        const res = await fetch(url, { cache: 'no-store' });
        if (res.ok){
          const json = await res.json();
          if (Array.isArray(json)){
            currentData = json;
            hydrate();
            return;
          }
        }
      }catch(e){ /* ignore */ }
      // fallback to sample
      initializeSampleData();
    }

    function initializeSampleData(){
      const sampleData = [
        {Event_ID:'E001', Event_Group:'‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list:'‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å', Province_Name:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', District_Name:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name:'‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å', Date_Received:'04-01-2567', case:25, Death:0, Priority:'‡∏™‡∏π‡∏á', Status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'},
        {Event_ID:'E002', Event_Group:'‡πÇ‡∏£‡∏Ñ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏©', Province_Name:'‡∏•‡∏≥‡∏õ‡∏≤‡∏á', District_Name:'‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤', Subdistrict_Name:'‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤', Date_Received:'20-02-2567', case:12, Death:1, Priority:'‡∏Å‡∏•‡∏≤‡∏á', Status:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'},
        {Event_ID:'E003', Event_Group:'‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏', Event_list:'‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏£‡∏≤‡∏à‡∏£', Province_Name:'‡∏•‡∏≥‡∏û‡∏π‡∏ô', District_Name:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name:'‡∏ô‡∏≤‡∏¢‡∏°', Date_Received:'10-03-2567', case:8, Death:2, Priority:'‡∏™‡∏π‡∏á', Status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'},
        {Event_ID:'E004', Event_Group:'‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list:'‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î-19', Province_Name:'‡πÅ‡∏û‡∏£‡πà', District_Name:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name:'‡πÉ‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Date_Received:'05-04-2567', case:45, Death:3, Priority:'‡∏™‡∏π‡∏á', Status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'},
        {Event_ID:'E005', Event_Group:'‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', Event_list:'‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', Province_Name:'‡∏ô‡πà‡∏≤‡∏ô', District_Name:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name:'‡πÉ‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Date_Received:'12-05-2567', case:30, Death:0, Priority:'‡∏Å‡∏•‡∏≤‡∏á', Status:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'},
        {Event_ID:'E006', Event_Group:'‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list:'‡∏°‡∏∑‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏õ‡∏≤‡∏Å', Province_Name:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢', District_Name:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name:'‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Date_Received:'18-06-2567', case:18, Death:0, Priority:'‡∏Å‡∏•‡∏≤‡∏á', Status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'},
        {Event_ID:'E007', Event_Group:'‡πÇ‡∏£‡∏Ñ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list:'‡∏û‡∏¥‡∏©‡∏à‡∏≤‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', Province_Name:'‡∏û‡∏∞‡πÄ‡∏¢‡∏≤', District_Name:'‡πÄ‡∏°‡∏∑‡∏≠‡∏á', Subdistrict_Name:'‡πÄ‡∏ß‡∏µ‡∏¢‡∏á', Date_Received:'22-07-2567', case:15, Death:1, Priority:'‡∏™‡∏π‡∏á', Status:'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'},
        {Event_ID:'E008', Event_Group:'‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏', Event_list:'‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ', Province_Name:'‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', District_Name:'‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', Subdistrict_Name:'‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢', Date_Received:'14-08-2567', case:22, Death:4, Priority:'‡∏™‡∏π‡∏á', Status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'},
        {Event_ID:'E009', Event_Group:'‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', Event_list:'‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà', Province_Name:'‡∏•‡∏≥‡∏õ‡∏≤‡∏á', District_Name:'‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞', Subdistrict_Name:'‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞', Date_Received:'08-09-2567', case:35, Death:0, Priority:'‡∏Å‡∏•‡∏≤‡∏á', Status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'},
        {Event_ID:'E010', Event_Group:'‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', Event_list:'‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢', Province_Name:'‡∏•‡∏≥‡∏û‡∏π‡∏ô', District_Name:'‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á', Subdistrict_Name:'‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á', Date_Received:'06-12-2567', case:28, Death:0, Priority:'‡∏Å‡∏•‡∏≤‡∏á', Status:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
      ];
      currentData = sampleData;
      hydrate();
    }

    // ------- Render all -------
    function hydrate(){
      updateDateRange(currentData);
      populateFilters(currentData);
      renderAll(getFilteredData());
      document.getElementById('rowCountLabel').textContent = `‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${fmtInt(currentData.length)}`;
    }

    function renderAll(data){
      updateSummary(data);
      createEventListTable(data);
      createEventGroupPieChart(data);
      createProvinceChart(data);
      createTimelineChart(data);
      createPriorityChart(data);
      createStatusChart(data);
      createDataTable(data);
    }

    function updateSummary(data){
      const totalEvents = data.length;
      const totalCases = data.reduce((s,r) => s + (parseInt(r.case)||0), 0);
      const totalDeaths = data.reduce((s,r) => s + (parseInt(r.Death)||0), 0);
      const provinces = uniq(data.map(r => r.Province_Name)).length;
      document.getElementById('totalEvents').textContent = fmtInt(totalEvents);
      document.getElementById('totalCases').textContent = fmtInt(totalCases);
      document.getElementById('totalDeaths').textContent = fmtInt(totalDeaths);
      document.getElementById('totalProvinces').textContent = provinces;
    }

    // ------- Charts & Tables (same spirit as user's file) -------
    function createEventListTable(data){
      const counts = {};
      data.forEach(r => { const k = r.Event_list || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; counts[k] = (counts[k]||0)+1; });
      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      const sorted = Object.entries(counts).sort(([,a],[,b])=>b-a);

      document.getElementById('eventListTitle').textContent = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (N= ${total})`;
      const maxCount = Math.max(1, ...sorted.map(([,c])=>c));
      let html = `<table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
          </tr>
        </thead><tbody class="bg-white divide-y divide-gray-200">`;

      sorted.forEach(([name,count],i)=>{
        const pct = ((count/total)*100).toFixed(1);
        const intensity = count/maxCount;
        const green = Math.round(255 - intensity*100);
        const bg = `rgba(34, ${green}, 34, ${0.1 + intensity*0.4})`;
        html += `<tr style="background:${bg}">
          <td class="px-4 py-3 text-sm font-medium text-gray-900">${i+1}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${name}</td>
          <td class="px-4 py-3 text-sm font-bold text-center text-gray-900">${fmtInt(count)}</td>
          <td class="px-4 py-3 text-sm font-medium text-center text-gray-900">${pct}%</td>
        </tr>`;
      });
      html += `<tr class="bg-blue-50 border-t-2 border-blue-200">
        <td class="px-4 py-3 text-sm font-bold text-blue-900" colspan="2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
        <td class="px-4 py-3 text-sm font-bold text-blue-900 text-center">${fmtInt(total)}</td>
        <td class="px-4 py-3 text-sm font-bold text-blue-900 text-center">100.0%</td>
      </tr></tbody></table>`;

      document.getElementById('eventListTable').innerHTML = html;
    }

    function createEventGroupPieChart(data){
      const counts = {};
      data.forEach(r => { const k = r.Event_Group || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; counts[k] = (counts[k]||0)+1; });
      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      const sorted = Object.entries(counts).sort(([,a],[,b])=>b-a);

      document.getElementById('eventGroupTitle').textContent = `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (N= ${total})`;
      const ctx = document.getElementById('eventGroupPieChart').getContext('2d');
      if (chartInstances.eventGroupPie) chartInstances.eventGroupPie.destroy();
      chartInstances.eventGroupPie = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: sorted.map(([n])=>n),
          datasets: [{
            data: sorted.map(([,c])=>c),
            backgroundColor: [
              'rgba(59,130,246,0.8)','rgba(16,185,129,0.8)','rgba(245,101,101,0.8)',
              'rgba(139,92,246,0.8)','rgba(251,191,36,0.8)','rgba(236,72,153,0.8)',
              'rgba(20,184,166,0.8)','rgba(249,115,22,0.8)','rgba(107,114,128,0.8)'
            ],
            borderColor:'#fff', borderWidth:3
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom', labels:{ usePointStyle:true, pointStyle:'circle', font:{ family:'Sarabun', size:12 } } },
            tooltip:{ callbacks:{ label:(c)=>{
              const count = c.parsed; const pct = ((count/total)*100).toFixed(1);
              return `${c.label}: ${fmtInt(count)} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${pct}%)`; } } }
          }
        }
      });
    }

    function createProvinceChart(data){
      const counts = {};
      data.forEach(r=>{ const k=r.Province_Name||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; counts[k]=(counts[k]||0)+1; });
      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      const sorted = Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,10);
      document.getElementById('provinceTitle').textContent = `‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (N= ${total})`;

      const ctx = document.getElementById('provinceChart').getContext('2d');
      if (chartInstances.province) chartInstances.province.destroy();
      chartInstances.province = new Chart(ctx, {
        type:'bar',
        data:{ labels: sorted.map(([n])=>n), datasets:[{
          label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', data: sorted.map(([,c])=>c),
          backgroundColor:'rgba(16,185,129,0.8)', borderColor:'rgba(16,185,129,1)',
          borderWidth:2, borderRadius:8, borderSkipped:false
        }]},
        options:{
          indexAxis:'y', responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false },
            tooltip:{ callbacks:{ label:(c)=>{
              const cnt=c.parsed.x; const pct=((cnt/total)*100).toFixed(1);
              return `${c.label}: ${fmtInt(cnt)} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${pct}%)`; } } } },
          scales:{
            x:{ beginAtZero:true, ticks:{ callback:(v)=>fmtInt(v) } },
            y:{ ticks:{ font:{ family:'Sarabun', size:12 } } }
          }
        }
      });
    }

    function createTimelineChart(data){
      const monthCounts = {};
      let minY=Infinity, maxY=-Infinity;
      data.forEach(r=>{
        const d = parseThaiDate(r.Date_Received);
        if (!d || isNaN(d)) return;
        const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0');
        const key=`${y}-${m}`;
        monthCounts[key]=(monthCounts[key]||0)+1;
        minY=Math.min(minY,y); maxY=Math.max(maxY,y);
      });
      const allMonths=[];
      if (minY!==Infinity && maxY!==-Infinity){
        for(let y=minY;y<=maxY;y++){
          for(let m=1;m<=12;m++){ allMonths.push(`${y}-${String(m).padStart(2,'0')}`); if(!monthCounts[`${y}-${String(m).padStart(2,'0')}`]) monthCounts[`${y}-${String(m).padStart(2,'0')}`]=0; }
        }
      }
      const total = data.length;
      document.getElementById('timelineTitle').textContent = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (N= ${total})`;

      const labels = allMonths.map(k=>{
        const [y,m]=k.split('-');
        const thMonths=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
        return `${thMonths[parseInt(m)-1]} ${y}`;
      });
      const vals = allMonths.map(k=>monthCounts[k]||0);

      const ctx = document.getElementById('timelineChart').getContext('2d');
      if (chartInstances.timeline) chartInstances.timeline.destroy();
      chartInstances.timeline = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{
          label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', data: vals,
          borderColor:'rgba(139,92,246,1)', backgroundColor:'rgba(139,92,246,0.1)',
          borderWidth:3, fill:true, tension:0.4
        }]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1, callback:(v)=>Number.isInteger(v)?v:'' } } }
        }
      });
    }

    function createPriorityChart(data){
      const map={}; data.forEach(r=>{ const k=r.Priority||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; map[k]=(map[k]||0)+1; });
      const total = Object.values(map).reduce((a,b)=>a+b,0);
      const sorted = Object.entries(map).sort(([,a],[,b])=>b-a);
      document.getElementById('priorityTitle').textContent = `‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß (N= ${total})`;

      const colorMap={'‡∏™‡∏π‡∏á':'rgba(239,68,68,0.8)','‡∏Å‡∏•‡∏≤‡∏á':'rgba(245,158,11,0.8)','‡∏ï‡πà‡∏≥':'rgba(34,197,94,0.8)','‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏':'rgba(156,163,175,0.8)'};
      const ctx=document.getElementById('priorityChart').getContext('2d');
      if (chartInstances.priority) chartInstances.priority.destroy();
      chartInstances.priority=new Chart(ctx,{
        type:'bar',
        data:{ labels:sorted.map(([n])=>'‚óè'), datasets:[{
          label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', data:sorted.map(([,c])=>c),
          backgroundColor: sorted.map(([n])=>colorMap[n]||'rgba(59,130,246,0.8)'),
          borderColor: sorted.map(([n])=>(colorMap[n]||'rgba(59,130,246,1)').replace('0.8','1')),
          borderWidth:2, borderRadius:8, borderSkipped:false
        }]},
        options:{
          responsive:true, maintainAspectRatio:false, plugins:{
            legend:{ display:false },
            tooltip:{ callbacks:{ title:(ctx)=>sorted[ctx[0].dataIndex][0], label:(c)=>{
              const cnt=c.parsed.y; const pct=((cnt/total)*100).toFixed(1);
              return `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${fmtInt(cnt)} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${pct}%)`; } } }
          },
          scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmtInt(v) } }, x:{ ticks:{ font:{ size:16, weight:'bold' } } } }
        }
      });
    }

    function createStatusChart(data){
      const map={}; data.forEach(r=>{ const k=r.Status||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; map[k]=(map[k]||0)+1; });
      const total = Object.values(map).reduce((a,b)=>a+b,0);
      const sorted = Object.entries(map).sort(([,a],[,b])=>b-a);
      document.getElementById('statusTitle').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (N= ${total})`;

      const ctx=document.getElementById('statusChart').getContext('2d');
      if (chartInstances.status) chartInstances.status.destroy();
      chartInstances.status = new Chart(ctx, {
        type:'bar',
        data:{ labels:sorted.map(([n])=>n), datasets:[{
          label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå', data:sorted.map(([,c])=>c),
          backgroundColor:['rgba(20,184,166,0.8)','rgba(251,191,36,0.8)','rgba(239,68,68,0.8)','rgba(139,92,246,0.8)','rgba(156,163,175,0.8)'],
          borderWidth:2, borderRadius:8, borderSkipped:false
        }]},
        options:{
          responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>fmtInt(v) } } }
        }
      });
    }

    function createDataTable(data){
      const header = document.getElementById('tableHeader');
      const body = document.getElementById('tableBody');
      header.innerHTML=''; body.innerHTML='';
      if (!data.length) return;
      const cols = Object.keys(data[0]);
      cols.forEach(c=>{
        const th=document.createElement('th');
        th.className='px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b';
        th.textContent=c; header.appendChild(th);
      });
      data.slice(-10).reverse().forEach((row,i)=>{
        const tr=document.createElement('tr'); tr.className = i%2===0 ? 'bg-white' : 'bg-gray-50';
        cols.forEach(c=>{ const td=document.createElement('td'); td.className='px-4 py-3 text-sm text-gray-900 border-b'; td.textContent=row[c]??'-'; tr.appendChild(td); });
        body.appendChild(tr);
      });
      if (data.length>10){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=cols.length; td.className='px-4 py-3 text-center text-sm text-gray-500 italic';
        td.textContent=`‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${fmtInt(data.length)} ‡πÅ‡∏ñ‡∏ß`; tr.appendChild(td); body.appendChild(tr);
      }
    }

    // ------- Export table to Excel -------
    document.getElementById('exportTableExcel').addEventListener('click', () => {
      const tbl = document.getElementById('dataTable');
      try{
        const wb = XLSX.utils.table_to_book(tbl, { sheet: 'Table' });
        XLSX.writeFile(wb, 'data_table.xlsx');
      }catch(e){
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      }
    });

    // ------- Upload Excel -------
    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      if (!f.name.match(/\.(xlsx|xls)$/i)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx ‡∏´‡∏£‡∏∑‡∏≠ .xls)'); return; }
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, { type:'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        currentData = json;
        hydrate();
      };
      reader.readAsArrayBuffer(f);
    });

    // ------- Download JSON -------
    document.getElementById('downloadJsonBtn').addEventListener('click', ()=>{
      if (!currentData.length){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î'); return; }
      const blob = new Blob([JSON.stringify(currentData, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'dashboard_data.json';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    // ------- Filter interactions -------
    function onCascadeChange(){
      // Update cascading options without re-rendering charts yet
      populateFilters(currentData);
    }
    provinceSel.addEventListener('change', onCascadeChange);
    districtSel.addEventListener('change', onCascadeChange);
    subdistrictSel.addEventListener('change', onCascadeChange);
    groupSel.addEventListener('change', onCascadeChange);
    eventSel.addEventListener('change', onCascadeChange);

    document.getElementById('applyFilters').addEventListener('click', ()=>{
      renderActiveFilterText();
      renderAll(getFilteredData());
    });
    document.getElementById('clearFilters').addEventListener('click', ()=>{
      provinceSel.value=''; districtSel.value=''; subdistrictSel.value=''; groupSel.value=''; eventSel.value='';
      populateFilters(currentData);
      renderAll(currentData);
    });

    // ------- Boot -------
    document.addEventListener('DOMContentLoaded', loadSharedData);
  </script>
</body>
</html>
